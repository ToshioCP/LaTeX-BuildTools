# Latex-Buildtools

現在の版はrubyで書かれている。以前のbashスクリプトで書かれた版はbashブランチに移動した。

### Latex-Buildtools作成の背景

文書が大きくなればなるほど、その作成や保守管理は難しくなる。
LaTeXによる文書作成も同様であり、その対策として次のようなことが考えられる。

- ソースファイルの分割と整理
- 分割コンパイル
- 前処理

Buildtoolsはこれらをサポートするツール群である。

### ソースファイルの分割と配置

300ページを越えるような本では、全体を「部、章、節」などに分けて整理する。
LaTeXではこれを「part, chapter, section」の各コマンドで表し、さらにその下位に「subsection, subsubsection」がある。
ファイルの分割では、通常section単位にファイルを設けるのが適当である。
そこで、partとchapterはディレクトリに、subsection以下はsectionファイルの中で記述することにする。

|部 - 節|part - subsubsection| ディレクトリ/ファイル |
|:-----:|:------------------:|:-----------:|
| 部（編） |        part        |   ディレクトリ    |
|  章  |      chapter       |   ディレクトリ    |
|  節  |      section       |    ファイル     |
|  項  |     subsection     |sectionファイルの中|
| （目） |   subsubsection    |sectionファイルの中|

これをディレクトリの構造で表すと、例えば次のようになる。

~~~
--+-- part1 --+-- chap1 --+-- sec1
  |           |           +-- sec2
  |           +-- chap2 ----- sec1
  +-- part2 --+-- chap1 --+-- sec1
              |           +-- sec2
              +-- chap2 ----- sec1
~~~

partがあるのは相当大きい書籍で、100ページ程度ならchapter以下だけで十分である。
その場合は次のようになる。

~~~
--+-- chap1 --+-- sec1
  |           +-- sec2
  |           +-- sec3
  +-- chap1 --+-- sec1
              +-- sec2
              +-- sec3
~~~

更に小さい文書であればsectionだけで足りる。
articleドキュントクラスを使う文書はsection以下だけを持っている。

~~~
--+-- sec1
  +-- sec2
  +-- sec3
  +-- sec4
  +-- sec5
~~~

これらのディレクトリ構成のいずれを選ぶかはその文書の大きさによる。
なお、上図ではファイルの拡張子は省略されている。

ディレクトリ名をpart1やchap2に、ファイル名をsec1（拡張子をつければsec1.texなど）に限定することにはメリットとデメリットがある。
メリットは、ファイルの順番が分かることとプログラムがファイルを見つけやすいことであり、デメリットはファイルの内容がファイル名からは分からないことである。
Buildtoolsでは、前者を重視して、ファイル名をpart,chap,secに固定することにした。
上記のファイルはサブファイルと呼ばれる。
サブファイルはルートファイルからインクルードされる。
それらの接続はプログラムが自動で行うので、ユーザはいちいち\\input{}コマンドを書かなくてよい。

本文以外のファイルは任意の場所に置くことができるが、画像ファイルをまとめてひとつのディレクトリに入れるのは良い方法である。

~~~
--+-- part1 --+-- chap1 --+-- sec1
  |           |           +-- sec2
  |           +-- chap2 ----- sec1
  +-- part2 --+-- chap1 --+-- sec1
  +           |           +-- sec2
  +           +-- chap2 ----- sec1
  +-- image --+-- photo.jpg
              +-- diagram.png
              +-- sample.png
~~~

本文のファイルからこれらのファイルをインクルードする時は、トップディレクトリからの相対パスで参照する。

~~~
\includegraphics{image/photo.jpg}
~~~

このことによって、

- 本文のファイルがchapやpartをまたいで移動してもコマンドのパス名を変更しなくてすむ。
- トップディレクトリをlualatexのカレントディレクトリとすることにより、相対パスが正しくlualatexに伝わる。

### タイプセット

lualatexによるソースファイルのコンパイルを「タイプセット」と呼ぶ。
タイプセットでは、相互参照のためにlualatexを2回以上実行する必要がある。
その管理を行うlatexmkというプログラムがある。
Buildtoolsではlatexmkを利用している。
そのおかげでユーザが何回もlualatexを実行する必要はない。
ユーザが行うのは、端末から

~~~
$ rake
~~~

とタイプするだけである。
あとは自動でタイプセットが行われる。

大きな文書ではタイプセットに時間がかかる。
ちょっとした訂正を確認するのに文書全体をタイプセットするのは時間がもったいない。
そのときはpart_typesetコマンドを使う。
これはサブファイル1つだけをコンパイルするプログラムである。
ただし、sectionや相互参照の番号は正しく反映されない。
あくまで確認用である。

~~~
$ part_typeset 1-1-1
~~~

このコマンドにより、part1/chap1/sec1のファイルだけがタイプセットされる。
partがなくてchapとsecしかない場合は、例えば「part_typeset 1-2」とすればchap1/sec2のファイルがタイプセットされる。
このようにひとつのファイルだけをタイプセットすることを部分タイプセットという。

exampleディレクトリにサンプルの文書があるので、そこでrakeコマンドを試してみるとよい。

タイプセットでは様々な中間ファイルとターゲットとなるpdfファイルが生成される。
これらは_buildディレクトリに保存される。
中間ファイルを削除したい時は

~~~
$ rake clean
~~~

とタイプすればよい。
ターゲットとなるpdfファイルも含めて削除したい時は

~~~
4 rake clobber
~~~

とタイプする。

### 前処理

タイプセットの前に前処理をすることができる。
例えば、マークダウンのファイルをLaTeXのファイルにコンバートすることは前処理のひとつである。

~~~
sec1.md ==(pandoc)==> sec1.tex ==(lualatex)==> XXX.pdf
~~~

このコンバートをするプログラムはpandocである。

~~~
https://pandoc.org/
~~~

前処理は自動で行われるので、ユーザはsec1.mdのように拡張子を「.md」にしておくだけでよい。

前処理をユーザが付け加えることができる。
たとえば、新たに「.src.tex」という拡張子をつけ、その拡張子のファイルでは「m(1,2,3,4)」を

~~~
\begin{bmatrix}1&2\\3&4\end{bmatrix}
~~~

に変換したいとする。
rubyのgsubメソッドまたはgsub!メソッドを使えばこのような変換ができる。
ユーザの作る前処理は「converter.rb」というファイルに記述してトップディレクトリに置く。

~~~
{ :'.src.tex' => lambda do |src, dst|
    buf = File.read(src)
    buf = buf.split(/(\\begin\{verbatim\}.*?\\end\{verbatim\}\n)/m)
    buf = buf.map do |s|
      s.match?(/^\\begin\{verbatim\}/) ? s : s.split(/(%.*$)/)
    end
    buf = buf.flatten
    buf.each do |s|
      unless s.match?(/^\\begin\{verbatim\}/) || s.match?(/^%/)
        s.gsub!(/m\((\d),(\d),(\d),(\d)\)/) {"\\begin{bmatrix}#{$1}&#{$2}\\\\#{$3}&#{$4}\\end{bmatrix}"}
      end
    end
    File.write(dst, buf.join)
  end }
~~~

3行目から7行目までは、verbatim環境、コメント部分とそれ以外の部分をわけ、9行目でverbatimとコメント以外の行を選び、10行目で変換をしている。
10行目をカスタマイズすることにより、様々な変換が可能である。
エクスクラメーションマークのついたgsub!でないと、変換が反映されないので注意が必要である。

コンバータによって変換されたファイルは、トップディレクトリ直下の「_build」ディレクトリに保存される。
「_build」ディレクトリをトップディレクトリの下に置くことにより、各ファイルが参照する相対パス（incudegraphicsやinputコマンドのパス）が正しく保たれる。

converter.rbの内容はプログラム側からチェックされることなく実行される。
もし内容に誤りがあれば、深刻な事態を引き起こしかねないので、事前にバックアップを取るなどの対策をおすすめする。
また、他人が作ったプログラムを、その内容を確認せずにconverter.rbとして実行することは非常に危険である。
これらのリスクを良く理解した上でコンバータのカスタマイズを行ってほしい。

拡張子について補足しておく。
拡張子はファイル名の最後のドットから後の部分であるから、「abc.de.fg」の拡張子は「.fg」であって「.de.fg」ではない。
しかし、本システムでは例外的に「.src.tex」を拡張子として取り扱うことにした。
このような例外は「.src.tex」と「.src.md」の2つである。
例えば「sec2.5.src.tex」の拡張子は「.src.tex」であって「.5.src.tex」でも「.tex」でもない。
「get_suffix」メソッドは、ファイル名を引数として、その拡張子（例外を含む正しい拡張子）を返す。

### 初期化

新しい文書を作る場合は、newtexを使う。
「newtex ディレクトリ名」で初期化されたディレクトリが作成される。
ディレクトリには、テンプレートが含まれている。

~~~
$ ls
Rakefile  cover.tex  gecko.png  helper.tex  main.tex
~~~

ほとんどの場合、Rakefileは動作する。
書き換えが必要になることはほとんどない。
他のファイルについては、

- cover.texは表紙のソースファイルである。
\\maketitileコマンドを使う場合はこのファイルは必要ない。
- gecko.pngはcover.texで使うヤモリのイラストである。
cover.texを変更して別のイラストを使うこともできる。
- helper.texはプリアンブルの部分である。
主にパッケージのインクルードと\\newcommandなどによるマクロ定義を行う。
ソースファイルにMarkdownを含む場合はhelper.texに定義を追加しなえればならないケースがある。
MarkdownファイルはPandocでTeXファイルに変換されてからタイプセットされるが、Pandocが未定義のコマンドを生成するからである。
例えば\\tightlistコマンドはitemize環境に対して挿入される。
helper.texでそのコマンドを定義しておかないとエラーが起こる。
どのような未定義コマンドが生成されるかは、Markdownファイルによる。
またどのように定義すればよいかは、Pandocのテンプレートファイルを参考にすると良い。
テンプレートファイルは`pandoc --print-default-template=latex`で見ることができる。
- main.texはルートファイルである。ここにサブファイルの取り込みを書く必要はない。
取り込みは自動的に行われる。

独自のコンバータを作る場合はこのディレクトリに「converter.rb」の名前のファイルを置く。

本文のファイルは、大きな文書であれば、part-chap-secのディレクトリとファイルを作り、小さな文書であればsecファイルをこのディレクトリに書く。

### ファイルの挿入とリナンバー

sec1とsec2の間に新たなsecファイルを入れたい場合は、1と2の間の任意の数のファイルを作る。
例えば、「sec1.5」のように小数を使う。
このままでも構わないが、整数の1,2,3,4...という連番に直したければrenumberコマンドを使う。

~~~
$ renumber
~~~

### アーカイブ

できあがった文書はアーカイブすることができる。

~~~
$ arch_tex -b
~~~

これですべての文書とRakefile、lib_latex_utils.rb、converter.rbがbzip2のファイルにアーカイブされる。
このとき、簡単な説明を記したreadme.mdも同梱される。
アーカイブされたものを配布する場合、受け取り手はBuildtoolsを必要としない。
必要なのはアーカイブを解凍するプログラムとruby環境だけである。
オプションで圧縮方法を選べる。
bzip2（-b）gzip（-g）とzip（-z）がサポートされている。


### インストールとアンインストール

インストールに必要なものはrubyとtex環境である。
ruby3.1で開発したが、2.0以降のrubyならば動くのではないかと思う。
tex環境はTexliveがおすすめである。
また、エンジンはlualatexになっているが、他のエンジンを使いたい場合はRakefileの若干の修正で対応できる。

作者のOS環境はLinuxであるが、Windowsなどでも動作するのではないかと思う。

Linuxの場合は

~~~
$ ruby install.rb
~~~

でインストールされる。
実行ファイルが`$HOME/bin`にコピーされる。
インストール時にnewtexとarch_texはプログラムの書き換えが行われる。

アンインストールは

~~~
$ ruby install.rb -
~~~

で行う。

###  ライセンス

Copyright (C) 2022  ToshioCP (関谷 敏雄)

Buildtoolsはフリーソフトウェアであり、フリーソフトウェア財団によって発行されたGNU 一般公衆利用許諾書(バージョン3またはそれ以降のバージョン)の定める条件の下で再頒布または改変することができる。

Buildtoolsは多くの人にとって有用であると考えて頒布されているものであるが、これは*全くの無保証* である。商業可能性の保証や特定の目的への適合性は、言外に示されたものも含め、全く存在しない。
詳しくは[GNU GENERAL PUBLIC LICENSE](https://www.gnu.org/licenses/gpl-3.0.html)をご覧いただきたい。
また、その参考として、八田真行氏による[GNU 一般公衆利用許諾書の非公式日本語訳](https://gpl.mhatta.org/gpl.ja.html)がある。
